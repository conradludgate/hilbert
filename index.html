<html>
<head>
    <style>
        #content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            flex-direction: column;
        }

        #canvas {
            width: 95%;
            height: 95%;
            aspect-ratio: 1;
        }
    </style>
</head>
<body>
    <div id="content">
        <canvas id="canvas"></canvas>
        <label id="nlabel" for="n">Hilbert Space:</label><input type="range" min="0" max="10" value="2" id="n">
        <label id="plabel" for="p">Point:</label><input type="range" min="0" max="1" value="0.36" step="0.001" id="p">
    </div>
    <script>

        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let content = document.getElementById("content");

        function setSize() {
            let s = Math.min(content.clientWidth, content.clientHeight);
            let wh = Math.floor(s * 0.90);
            canvas.width = wh;
            canvas.height = wh;
            canvas.style.width = wh;
            canvas.style.height = wh;
            canvas.style["margin-top"] = s * 0.025;
            canvas.style["margin-bottom"] = s * 0.01;
        }

        let canvas2 = document.createElement("canvas");
        let ctx2 = canvas2.getContext("2d");

        let _n = document.getElementById("n");
        let _p = document.getElementById("p");

        function draw() {
            let n = _n.value;
            let p = _p.value;

            let w = canvas.width;
            let h = canvas.height;

            canvas2.width = w;
            canvas2.height = h;

            ctx.setTransform(w, 0, 0, h, 0, 0);
            ctx.clearRect(0, 0, 1, 1);

            ctx.transform(1/2, 0, 0, 1/2, 0, 0);

            ctx.beginPath();
            ctx.lineWidth = 0.05;
            ctx.moveTo(0, 0.5);
            ctx.lineTo(0.5, 0.5);
            ctx.lineTo(0.5, 1.5);
            ctx.lineTo(1.5, 1.5);
            ctx.lineTo(1.5, 0);
            ctx.stroke();

            for (let i = 0; i < n; i++) {
                ctx2.putImageData(ctx.getImageData(0, 0, w, h), 0, 0);

                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, w, h);
                ctx.scale(0.5, 0.5)

                ctx.drawImage(canvas2, w, h);

                ctx.rotate(-Math.PI / 2);
                ctx.drawImage(canvas2, -w, 0);

                ctx.scale(1, -1)
                ctx.drawImage(canvas2, -w, -2*h);

                ctx.rotate(Math.PI / 2);
                ctx.drawImage(canvas2, -w, h);

                let shift = 3 + i;

                ctx.setTransform(-w >> shift, 0, 0, h >> shift, w, 0);
                ctx.clearRect(0, 0, 0.95, 2);
                ctx.beginPath();
                ctx.lineWidth = 0.1;
                ctx.moveTo(1, 1);
                ctx.lineTo(1, 0);
                ctx.stroke();
            }
        }

        // redraw on input change
        _n.addEventListener("input", () => {
            document.getElementById("nlabel").innerText = `Hilbert Space: ${_n.value}`
            draw();
        });
        _p.addEventListener("input", () => {
            document.getElementById("plabel").innerText = `Point: ${_p.value}`
            draw();
        });

        // update canvas size and redraw on window resize
        //window.addEventListener("resize", function () {
        //    setSize();
        //    draw();
       // });

        // mobile coordinates are weird. delay a little so the renderer has a chance to update properly
        setTimeout(() => {
            setSize();
            draw();
        }, 200);

        document.getElementById("nlabel").innerText = `Hilbert Space: ${_n.value}`
        document.getElementById("plabel").innerText = `Point: ${_p.value}`
    </script>
</body>
</html>
